# IBI post-pivot configuration

- [IBU/I post pivot configuration](#ibi-post-pivot-configuration)
  - [Overview](#overview)
  - [Network configuration](#network-configuration)
  - [Recertification flow](#recertification-flow)
  - [User specifications](#user-specifications)

## Overview

Post pivot configuration is the first thing running after node reboots into new stateroot.
It runs as part of [installation-configuration.service](../lca-cli/installation_configuration_files/services/installation-configuration.service)
It is on charge of list of operation that should occur in order for cluster to start:

- Perform networking configuration
- Recertification
- User specifications:
  - Apply new hostname
  - Apply new ip
  - Apply all user specific configurations that user provides as [seed reconfiguration](../api/seedreconfig/seedreconfig.go)
  - Applying extra manifests

## Mount configuration folder

There are 2 different ways to provide configuration folder:

1. Add it as part of stateroot configuration process as we do in IBU, should be placed in /opt/openshift
2. Provide it as block device with label "relocation-config" , in this case we will mount it.

Folder structures can be seen [prepare-installation-configuration.sh](../ibu-imager/installation_configuration_files/scripts/prepare-installation-configuration.sh
and will be described later on

## Network configuration

User can provide specific network configuration that he wants to be applied on the node as part of installation process.
Currently, we support nmconnection files that should be placed in /opt/openshift/network-configuration/system-connections
Prepare installation service is on charge to copy them to network manager configuration folder and restart NM
[prepare-installation-configuration.sh](../lca-cli/installation_configuration_files/scripts/prepare-installation-configuration.sh)

## Recertification flow

Part of installation flow is recertification of the sno cluster, this process requires list of certificates provided by user.
List of files can be seen here [recert.go](../internal/recert/recert.go)
Those certificates currently are expected to be in /opt/openshift/certs folder.

## User specifications

We provide a way to specify a list of parameters that should be provided as json file in /opt/openshift/cluster-configuration/manifest.json
This file structure can be seen as struct in [SeedReconfiguration](../api/seedreconfig/seedreconfig.go)

### Hostname

Post pivot process is on charge of changing hostname for the node. User should provide new hostname that will be put into
/etc/hostname. When ocp cluster will start it will not have any nodes and new node with set hostname will be added.

### ClusterName

The desired cluster name for the cluster. Equivalent to install-config.yaml's clusterName.
This will replace the cluster name of the seed cluster.

### BaseDomain

The desired base domain for the cluster. Equivalent to install-config.yaml's baseDomain.
This will replace the base domain of the seed cluster.

#### ClusterName and BaseDomain fields

Recert will use those fields in order to generate new CN name in cluster certificates
and will change old one to new one in all relevant places.
Params can be seen here [recert.go](../internal/recert/recert.go)

### ClusterID

The desired cluster-ID. During an IBU, this is the ID of the original SNO.
During an IBI, this can either be empty, in which case a new cluster-ID will be generated by LCA, or it can be set to the ID of the
new cluster, in case one had to be pre-generated for some reason.

### Release registry

In order to set right release image registry in post pivot operation we need to get user release registry
that will be set in clusterversion release image param in case seed was created with another one.
